USE DATABASE ;
USE WAREHOUSE LOCAL_marvinfoster;
USE ROLE CJ_MS;

with therapy as (
SELECT
    act.org_id,
    act.fk_facility_id,
    count(*) as activity_count,
    count(distinct act.fk_patient_id) as patient_count,
    count(distinct case when pxm.patient_frailty_group like '%lderly%' then act.fk_patient_id else null end) as frail_patient_count,
    sum(act.claim_line_paid_amt) as total_spend,
    count(*)*1.0/count(distinct act.fk_patient_id) as claims_per_patient,
    sum(act.claim_line_paid_amt)/count(distinct act.fk_patient_id) as spend_per_patient
FROM insights.activity act 
LEFT JOIN (select * from insights.patient_x_month where attribution_type = 'as_is') pxm 
    on act.activity_thru_month_cd = pxm.month_cd and act.fk_patient_id = pxm.fk_patient_id
WHERE 
    pxm.attribution_curr_period_flag = true 
    and get(act.procedure_hcpcs_mod_cd_list,0) in ('GP','GO','GN')
      and act.procedure_hcpcs_cd in 
    ('64550',
    '90901',
    '90911',
    '90912',
    '90913',
    '92506',
    '92507',
    '92508',
    '92520',
    '92521',
    '92522', 
    '92523',
    '92524',
    '92526', 
    '92597',
    '92605',
    '92606',
    '92607',
    '92608',
    '92609',
    '92610',
    '92611',
    '92612',
    '92614',
    '92616',
    '92618',
    '95831',
    '95832',
    '95833',
    '95834',
    '95851',
    '95852',
    '95992',
    '96105',
    '96111',
    '96125',
    '97001',
    '97002',
    '97003',
    '97004',
    '97010',
    '97012',
    '97016',
    '97018',
    '97022',
    '97024',
    '97026',
    '97028',
    '97032',
    '97033',
    '97034',
    '97035',
    '97036',
    '97039',
    '97110',
    '97112',
    '97113',
    '97116',
    '97124',
    '97129',
    '97130',
    '97139',
    '97140',
    '97150',
    '97161',
    '97162',
    '97163',
    '97164',
    '97165',
    '97166',
    '97167',
    '97168',
    '97504',
    '97520',
    '97530',
    '97532',
    '97533',
    '97535',
    '97537',
    '97542',
    '97597',
    '97598',
    '97602',
    '97605',
    '97606',
    '97607',
    '97608',
    '97610',
    '97703',
    '97750',
    '97755',
    '97760',
    '97761',
    '97762',
    '97763',
    '97799',
    '98966',
    '98967',
    '98968',
    '98970',
    '98971',
    '98972',
    'G0281',
    'G0283',
    'G0329',
    'G0451',
    'G0456',
    'G0457',
    'G0515',
    'G2010',
    'G2012',
    'G2061',
    'G2062',
    'G2063',
    'G2250',
    'G2251')
    and act.activity_from_month_cd in
    ('m-2021-04',
        'm-2021-05',
        'm-2021-06',
        'm-2021-07',
        'm-2021-08',
        'm-2021-09',
        'm-2021-10',
        'm-2021-11',
        'm-2021-12',
        'm-2022-01',
        'm-2022-02',
        'm-2022-03')
group by 1,2 
order by 3 desc
),

combo as (
select * from therapy
)


select 
    fk_facility_id,
    sum(activity_count) as activity_count,
    sum(patient_count) as patient_count,
    sum(frail_patient_count) as frail_patient_count,
    sum(total_spend) as total_spend,
    sum(activity_count)*1.00/sum(patient_count) as claims_per_patient,
    sum(total_spend)*1.00/sum(patient_count) as spend_per_patient
from combo
group by 1